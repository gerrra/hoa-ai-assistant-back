# Система топиков HOA AI Assistant

## Обзор

Новая система топиков кардинально улучшает работу с документами в HOA AI Assistant. Вместо простого разбиения документов на чанки, система теперь использует LLM для анализа документов и выделения тематических разделов (топиков).

## Как это работает

### 1. Загрузка документа
- Пользователь загружает документ (PDF или TXT)
- Система автоматически включает анализ топиков (можно отключить для больших файлов)

### 2. Анализ топиков
- LLM (GPT-4o) анализирует документ и выделяет основные темы
- Для каждой темы создается топик с:
  - **Названием** (например, "Парковка", "Платежи")
  - **Описанием** (краткое описание темы)
  - **Контентом** (весь релевантный текст по теме)
  - **Номерами страниц** (где упоминается тема)

### 3. Поиск и ответы
- При получении вопроса система ищет релевантные топики
- LLM анализирует найденные топики и генерирует ответ
- В источниках показывается конкретный топик, который использовался

## Преимущества новой системы

1. **Лучшее понимание контекста** - топики содержат всю информацию по теме
2. **Более точные ответы** - LLM работает с полным контекстом темы
3. **Улучшенные источники** - пользователь видит конкретную тему, а не случайный чанк
4. **Автоматическая категоризация** - документы автоматически структурируются по темам

## Структура базы данных

### Таблица `topics`
```sql
CREATE TABLE topics (
  id BIGSERIAL PRIMARY KEY,
  document_id INT REFERENCES documents(id) ON DELETE CASCADE,
  title TEXT NOT NULL,                    -- название топика
  description TEXT,                       -- описание топика
  content TEXT NOT NULL,                  -- весь контент топика
  embedding VECTOR(1536),                 -- эмбеддинг для поиска
  token_count INT,                        -- количество токенов
  page_numbers TEXT,                      -- номера страниц (JSON)
  visibility TEXT DEFAULT 'resident',
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### Обновленная таблица `chunks`
```sql
ALTER TABLE chunks ADD COLUMN topic_id INT REFERENCES topics(id) ON DELETE SET NULL;
```

## API Endpoints

### Загрузка документа
```
POST /admin/api/upload
```
Параметры:
- `use_topic_analysis: bool` - использовать анализ топиков (по умолчанию true)

Ответ:
```json
{
  "document_id": 123,
  "topics_inserted": 5,
  "chunks_inserted": 15,
  "status": "success"
}
```

### Получение топиков документа
```
GET /admin/api/documents/{doc_id}/topics
```

Ответ:
```json
[
  {
    "id": 1,
    "topic_index": 1,
    "title": "Парковка",
    "description": "Правила парковки и штрафы",
    "start_page": 5,
    "end_page": 8,
    "created_at": "2024-01-15T10:30:00Z"
  }
]
```

## Использование

### 1. Миграция базы данных
```bash
cd hoa-ai-assistant-back
python scripts/migrate_topics.py
```

### 2. Тестирование системы
```bash
python scripts/test_topics.py
```

### 3. Загрузка документа с анализом топиков
```python
from ingest.save import save_document

result = save_document(
    community_id=1,
    title="Устав ТСЖ",
    doc_type="CC&R",
    file_path="path/to/document.pdf",
    visibility="resident",
    use_topic_analysis=True
)
```

### 4. Поиск по топикам
```python
from search.retrieve import search_topics, format_context_topics

# Поиск релевантных топиков
topics = search_topics(community_id=1, query="парковка лодок", k=3)

# Форматирование контекста
context = format_context_topics(topics)
```

### 5. Генерация ответов
```python
from llm.answer import answer_question

# Ответ с использованием топиков
result = answer_question(
    community_id=1,
    role="resident",
    question="Можно ли оставить лодку на улице?",
    k=3,
    use_topics=True
)
```

## Конфигурация

### Переменные окружения
- `OPENAI_API_KEY` - ключ API OpenAI для анализа топиков
- `CHUNK_MAX_TOKENS` - максимальное количество токенов в чанке (по умолчанию 800)
- `CHUNK_OVERLAP_TOKENS` - перекрытие между чанками (по умолчанию 100)

### Настройки анализа топиков
- Для файлов больше 10MB автоматически отключается анализ топиков
- Можно принудительно отключить через параметр `use_topic_analysis=False`

## Мониторинг

### Логи
Система выводит подробные логи процесса анализа:
```
Processing document: Устав ТСЖ
Using topic analysis: True
Analyzing document topics with LLM...
Found 5 topics
Processing topic 1/5: Парковка
Topic 'Парковка' inserted with ID: 1
```

### Админ-интерфейс
- В админ-панели отображается количество созданных топиков
- Можно просматривать топики каждого документа
- Показывается описание и номера страниц для каждого топика

## Обратная совместимость

- Старая система чанков продолжает работать
- Можно переключаться между топиками и чанками
- API endpoints остаются совместимыми

## Производительность

- Анализ топиков требует больше времени (зависит от размера документа)
- Для больших документов (>10MB) рекомендуется отключать анализ топиков
- Поиск по топикам быстрее, чем по чанкам (меньше результатов для обработки)

## Troubleshooting

### Ошибка "No topics found"
- Проверьте, что документ содержит текст
- Убедитесь, что `use_topic_analysis=True`
- Проверьте логи на наличие ошибок API

### Медленная загрузка
- Для больших файлов отключите анализ топиков
- Уменьшите `CHUNK_MAX_TOKENS` в настройках

### Неточные топики
- Проверьте качество исходного документа
- Убедитесь, что документ на русском или английском языке
- Попробуйте другой тип документа (`doc_type`)
